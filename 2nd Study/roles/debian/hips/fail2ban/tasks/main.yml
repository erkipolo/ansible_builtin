- name: Instalar HIPS
  ansible.builtin.apt:
    name:
      - fail2ban
    state: present

- name: If main config exists
  ansible.builtin.stat:
    path: /etc/fail2ban/jail.local
  register: file_check

- name: Creamos una configuraci√≥n local
  ansible.builtin.copy:
    src: /etc/fail2ban/jail.conf
    dest: /etc/fail2ban/jail.local
    remote_src: true
    owner: root
    group: root
    mode: '0644'
  when: file_check.stat.exists == false

- name: Configurar HIPS 1
  ansible.builtin.lineinfile:
    dest: /etc/fail2ban/jail.local
    regexp: "^bantime  = 10m"
    line: 'bantime  = 10h'
  notify: restart_fail2ban

- name: Configurar HIPS 2
  ansible.builtin.lineinfile:
    dest: /etc/fail2ban/jail.local
    regexp: "^maxretry = 5"
    line: 'maxretry = 3'
  notify: restart_fail2ban

- name: Configuramos la rotacion de las bitacoras del HIPS
  ansible.builtin.template:
    src: fail2ban.j2
    dest: /etc/logrotate.d/fail2ban
    owner: root
    group: root
    mode: '0644'
  notify: restart_fail2ban
